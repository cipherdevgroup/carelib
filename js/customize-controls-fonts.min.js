!function(t,e,o,n,i,s){"use strict";var l=i.customize,a={},r=carelibFontsControlsSettings;o.extend(a,{model:{},view:{}}),a.model.Font=n.Model.extend({idAttribute:"family",defaults:{family:"",service:"",stack:""},toJSON:function(){return o.clone(this.attributes)}}),a.model.Fonts=n.Collection.extend({model:a.model.Font,comparator:function(t){return t.get("family")}}),a.model.FontControl=n.Model.extend({defaults:{control:{},dropdown:"closed",font:{},selection:{}},initialize:function(){this.listenTo(this,"change:selection",this.updateFont),this.get("font").on("change",o.throttle(this.updateSetting,50),this)},closeDropdown:function(){return this.set("dropdown","closed"),this},isDropdownOpen:function(){return"open"===this.get("dropdown")},openDropdown:function(){return this.set("dropdown","open"),this},resetSelection:function(){var t=this.get("control").params.defaultFont,e=a.findFont(t);return this.closeDropdown(),this.set("selection",new a.model.Font),this.get("font").set(e.toJSON()),this},toggleDropdown:function(){return this.isDropdownOpen()?this.closeDropdown():this.openDropdown(),this},updateFont:function(){var t=this.get("selection"),e=o.pick(t.toJSON(),"family","service","stack");return this.get("font").set(e),this},updateSetting:function(){var t=this.get("font");return this.get("control").setting.set(t.toJSON()),this}}),a.view.FontControl=i.Backbone.View.extend({template:i.template("carelib-fonts-control-font"),initialize:function(){this.allFonts=this.collection,this.params=this.options.control.params,this.collection=new a.model.Fonts,this.filterFonts(),this.listenTo(this.allFonts,"reset",this.filterFonts),this.listenTo(this.allFonts,"remove",this.maybeResetSelection)},render:function(){return this.$el.html(this.template({description:this.options.description,label:this.options.label})),this.views.add(".carelib-fonts-control-content",[new a.view.FontDropdown({collection:this.collection,control:this.options.control})]),this},filterFonts:function(){var t=this.allFonts.toJSON(),e=this.options.control;this.params.tags.length&&(t=o.filter(t,function(t){return o.intersection(e.params.tags,t.tags).length>0||"google"!==t.service})),this.params.excludeFonts.length&&(t=o.filter(t,function(t){return-1===e.params.excludeFonts.indexOf(t.family)})),this.collection.reset(t)},maybeResetSelection:function(t){var e=this.options.control.state;o.isEqual(t.toJSON(),e.get("selection").toJSON())&&e.resetSelection()}}),a.view.FontDropdown=i.Backbone.View.extend({className:"carelib-fonts-dropdown",tagName:"div",initialize:function(){this.state=this.options.control.state,this.listenTo(this.state,"change:dropdown",this.updateOpenClass),this.listenTo(this.state,"change:selection",this.updateSelectionClass)},render:function(){return this.views.add([new a.view.FontDropdownToggle({control:this.options.control}),new a.view.FontDropdownResetButton({control:this.options.control}),new a.view.FontList({collection:this.collection,control:this.options.control})]),this.updateSelectionClass(),this},updateDropdownPositionAndHeight:function(){var o,n=t.innerHeight||e(t).height(),i=this.$el.closest(".accordion-section-content"),s=this.$el.find(".carelib-fonts-list"),l=n-i.offset().top-i.outerHeight(),a=n-this.$el.offset().top-this.$el.outerHeight()-l;a>=120?(this.$el.removeClass("is-reversed"),s.css("max-height",a-2+"px")):(o=this.$el.offset().top-i.offset().top,this.$el.addClass("is-reversed"),s.css("max-height",o-12+"px"))},updateOpenClass:function(){var t=this.$el.closest(".accordion-section-content");this.state.isDropdownOpen()?(this.updateDropdownPositionAndHeight(),t.css("overflow","hidden"),this.$el.addClass("is-open")):(t.css("overflow-y","auto"),this.$el.removeClass("is-open"))},updateSelectionClass:function(){var t=this.state.get("selection").get("family");this.$el.toggleClass("has-selection",""!==t)}}),a.view.FontDropdownToggle=i.Backbone.View.extend({className:"carelib-fonts-dropdown-toggle",tagName:"span",events:{click:"toggleDropdown"},initialize:function(){this.state=this.options.control.state,this.listenTo(this.state,"change:selection",this.render)},render:function(){var t=this.state.get("selection").get("family"),e=this.state.get("selection").get("stack");return""!==t?this.$el.text(t).css("font-family",e):this.$el.text(r.l10n.defaultFont).css("font-family",""),this},toggleDropdown:function(){this.state.toggleDropdown()}}),a.view.FontDropdownResetButton=i.Backbone.View.extend({className:"carelib-fonts-dropdown-reset-button",tagName:"button",events:{click:"resetSelection"},render:function(){return this.$el.text(r.l10n.reset),this},resetSelection:function(t){t.preventDefault(),this.options.control.state.resetSelection()}}),a.view.FontList=i.Backbone.View.extend({className:"carelib-fonts-list",tagName:"ul",initialize:function(){this.listenTo(this.collection,"reset",this.render)},render:function(){return this.$el.empty(),this.collection.each(this.addFont,this),this},addFont:function(t){var e=new a.view.FontListItem({control:this.options.control,model:t});this.$el.append(e.render().el)}}),a.view.FontListItem=i.Backbone.View.extend({className:"carelib-fonts-list-item",tagName:"li",events:{click:"updateSelection"},initialize:function(){this.state=this.options.control.state,this.listenTo(this.state,"change:selection",this.toggleSelectedClass)},render:function(){var t=this.model.get("family"),e=this.model.get("service");return this.$el.text(t).css("font-family",this.model.get("stack")).addClass("is-"+e),this.toggleSelectedClass(),this},toggleSelectedClass:function(){var t=this.model.get("family"),e=this.state.get("selection").get("family");this.$el.toggleClass("is-selected",t===e)},updateSelection:function(){var t=this.model.get("family");this.state.closeDropdown().set("selection",a.findFont(t))}}),a.fonts=new a.model.Fonts(r.fonts),a.findFont=function(t,e){var o=a.fonts.findWhere({family:t});return e=e||{},o||new a.model.Font(e)},a.loadGoogleFonts=function(){o.each(a.fonts.where({service:"google"}),function(t){var e=t.get("family");WebFont.load({google:{families:[e],text:e}})})},a.loadTypekitFonts=function(t){var n="https://typekit.com/api/v1/json/kits/%s/published?callback=?";return t=t.replace(/[^a-z0-9]+/,""),""!==t?e.ajax(n.replace("%s",t),{dataType:"json"}).done(function(e){o.each(e.kit.families,function(t){a.fonts.add({family:t.name,stack:t.css_stack,service:"typekit"})}),WebFont.load({typekit:{id:t}}),a.fonts.trigger("reset")}):void 0},a.unloadTypekitFonts=function(){var t=a.fonts.where({service:"typekit"});a.fonts.remove(t)},l.sectionConstructor["carelib-fonts"]=l.Section.extend({googleFontsLoaded:!1,typekitLoadedKits:[],attachEvents:function(){var t,n;this.expanded.bind(o.bind(this.maybeLoadFonts,this)),t=this.container.find(".carelib-fonts-section-toggle"),n=this.container.find(".carelib-fonts-section-content"),t.on("click keydown",function(o){var i=e(this),s=n.filter(i.data("target"));l.utils.isKeydownButNotEnterEvent(o)||(o.preventDefault(),"true"===i.attr("aria-expanded")?(s.slideUp("fast"),i.attr("aria-expanded","false")):(s.slideDown("fast"),i.attr("aria-expanded","true"),n.not(s).slideUp("fast"),t.not(i).attr("aria-expanded","false")))}),e("#carelib-fonts-option-typekit-id").on("change",this.updateTypekitId),l.Section.prototype.attachEvents.apply(this,arguments)},maybeLoadFonts:function(){var t=l("carelib_fonts_typekit_id")();this.googleFontsLoaded||(a.loadGoogleFonts(),this.googleFontsLoaded=!0),""!==t&&-1===this.typekitLoadedKits.indexOf(t)&&(a.loadTypekitFonts(t),this.typekitLoadedKits.push(t))},updateTypekitId:function(t){var o=e(this),n=o.parent(),i=n.find(".spinner");return a.unloadTypekitFonts(),""===o.val()?(l("carelib_fonts_typekit_id").set(""),void a.fonts.trigger("reset")):(i.addClass("is-active"),void a.loadTypekitFonts(o.val()).done(function(t){l("carelib_fonts_typekit_id").set(o.val())}).always(function(){i.removeClass("is-active")}))}}),l.controlConstructor["carelib-font"]=l.Control.extend({ready:function(){var t=a.findFont(this.params.value.family,this.params.value);this.params.defaultFont===t.get("family")&&(t=new a.model.Font),this.state=new a.model.FontControl({control:this,font:new a.model.Font(this.params.value),selection:t}),this.view=new a.view.FontControl({collection:a.fonts,control:this,description:this.params.description,el:this.container,label:this.params.label}),this.view.render()}})}(window,jQuery,_,Backbone,wp);